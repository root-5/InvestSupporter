# 要件定義

## 背景

資産額増加や手数料無料で取れる投資戦略が多くなっていく中、投資以外のメイン業務や副業にもリソースを割いていきたいという背景のもと本システム構築の取り組み始めた。

## 目的

投資を効率化すること。具体的には以下の 3 項目の達成を意識する。

1. 判断を下すまでの現状分析の時間短縮
2. 他作業中に目移りしない明確な根拠の確立
3. 過去の判断を明示し、他作業からの復帰ロスを削減

## 機能要件

### 現行であるシステム

現行のシステムは以下の 3 つのシステムがバラバラに存在している。

-   **複数口座管理**

    GAS とスプレッドシート上に構築されたシステム。資産の現状把握と記録をリアルタイム（30 分間隔）で自動更新、モバイルからも閲覧・編集が可能。

    -   環境
        -   GAS
        -   スプレッドシート
    -   外部連携
        -   GmailAPI（SBI 約定メール）
        -   スクレイピング（Google ファイナンス）
        -   手入力（入出金データ）
    -   機能詳細
        -   現在のポートフォリオの円グラフと表
        -   取引履歴のログ
        -   資産のログ
        -   入出金ログ

-   **JquantsAPI**

    Node を使用してローカルでコマンド実行されるシステム。[JquantsAPI](https://jpx.gitbook.io/j-quants-ja/)を利用した情報収集を行う。

    -   環境
        -   Node.js（ローカルからコマンド実行）
    -   外部連携
        -   JquantsAPI
    -   機能詳細
        -   上場銘柄一覧の取得
        -   上場銘柄財務データの取得
        -   終値の取得

-   **Investing**

    Node を使用してローカルでコマンド実行されるシステム。SBI の登録銘柄を取得して、リストにある銘柄の決算日をトレーダーズウェブの決算発表日一覧ページから取得する。
    ※ 基本的にスクレイピングは禁止のサイトであるためあくまで構想。

    -   環境
        -   Node.js（ローカルからコマンド実行）
    -   外部連携
        -   スクレイピング（SBI 証券）
        -   スクレイピング（トレーダーズウェブ）
    -   機能詳細
        -   SBI 登録銘柄の取得
        -   決算日データ取得

### 最終的に作りたいシステム

基本的には現行システムを統合、拡張、WEB システム化する。

-   **Invest**
    -   環境
        -   スプレッドシート
        -   GAS（バックエンドとの通信）
        -   Node.js（サーバー上）
    -   外部連携
        -   IMAP（Gmail SBI 約定メール）
        -   JquantsAPI
        -   スクレイピング（SBI 証券）
    -   機能統合
        -   現在のポートフォリオの円グラフと表
        -   取引履歴のログ
        -   資産のログ
        -   入出金ログ
        -   上場銘柄一覧の取得
        -   上場銘柄財務データの取得
        -   終値の取得
        -   SBI 登録銘柄の取得
        -   決算日データ取得
    -   追加機能
        -   所持銘柄の PER, PBR, 自己資本比率, 配当
        -   流動性が低い・変動性が高い銘柄の割合の表示
        -   特定の反対売買を前提とした取引の記録と後のリマインド
        -   リバランス提案
        -   時価総額推移と TOPIX との比較
        -   検討リストの決算日リストアップ
        -   ※ 定期的な推奨銘柄リストアップ（テクニカル + ファンダメンタル）
        -   ※ 詳細なスクリーニング
        -   ※ アラート（ボリンジャー、閾値 3%）

## 非機能要件

長い間使い続けながら、常に更新しながら使用するために、以下の要件を満たすことを目指す。

1. 外部変化に強く、長く保守しやすいシステム
2. 一部機能がエラー発生やデプロイ作業によりダウンしても全体が機能する分散化されたシステム
3. 機能ごとの言語・フレームワークレベルでの更新が容易なシステム

## 副次的目的

-   テスト駆動開発の導入
-   デプロイ自動化の導入

# 基本設計

## クリーンアーキテクチャ

非機能要件 1.を満たすため、クリーンアーキテクチャの考えを取り入れる。

1. 第 1 層
   外部アプリ、外部システム、フレームワーク依存のレイヤー、内部のロジックで生成したデータのみを渡すイメージ。

    1. DB（postgres）
    2. 外部連携
        1. JquantsAPI
        2. IMAP（Gmail SBI 約定メール）
        3. スクレイピング（SBI 証券）
    3. UI（スプレッドシート）

2. 第 2 層
   第 1 層に依存度が高いロジックのみが書かれるレイヤー、コントローラー。

    1. OPM（Prisma）
    2. 外部 API 用整形ロジック
        1. JquantsAPI
        2. IMAP（Gmail SBI 約定メール）
        3. スクレイピング（SBI 証券）
    3. スプレッドシート用アクセスポイント（express）

3. 第 3 層
   第 1 層への依存が全くないレイヤー

4. 第 4 層
   ビジネスロジック。社会的なルールが変化しない限り不変なコードのみが書かれるレイヤー。

## マイクロサービスアーキテクチャ

非機能要件 2.と 3.を満たすため、マイクロサービスアーキテクチャの考えを取り入れる。

特に外部連携、機能単位ごとにサービスを分割し、独立して動作するようにすることで、一部機能がエラー発生やデプロイ作業によりダウンしても全体が機能する分散化されたシステムを目指す。


# 詳細設計
