# 作業メモ

## Jquants 公式 MCP サーバー導入

- [Jquants MCP - GitHub](https://github.com/J-Quants/j-quants-doc-mcp)
- [Github 公式 MCP 導入手順](https://docs.github.com/ja/copilot/how-tos/provide-context/use-mcp/extend-copilot-chat-with-mcp)

1. uv はすでにホストにインストール済みだった
2. `uv tool install git+https://github.com/J-Quants/j-quants-doc-mcp.git`
3. `mkdir .vscode`
4. `touch .vscode/mcp.json`
5. ファイルに以下を記述
   ```json
   {
     "servers": {
       "j-quants-doc-mcp": {
         "command": "uvx",
         "args": ["j-quants-doc-mcp"]
       }
     }
   }
   ```
6. Agent モードの GitHub Copilot に対し、「j-quants-doc-mcp を使えるかテストして」と質問
7. ヘルスが正常であり、正常な返答が返ってくることを確認

## 実装指示

1. 修正手順作成
    ```markdown
    Jquant API の直近のアップデートを本プロジェクトに適用したいです。
    現在のしているバージョンは v1 ですが、最新のバージョン v2 への移行を行います。
    まず、変更が必要な箇所をすべて特定し、修正手順を documents/作業メモ.md に記載してください。

    v1 から v2 への変更点は j-quants-doc-mcp を利用して確認してください。

    変更の中心となるディレクトリ・ファイルは以下の通りです。
    - Jquant モジュール: sapp/controller/jquants
    - 全体で使用する構造体定義: app/domain/model/structs.go
    ```
2. 修正の実施
    ```markdown
    documents/作業メモ.md に記載した修正手順に従い、Jquant API v2 への移行を実施してください。
    ```
3. テストの実施と追加修正
   ```markdown
   JQUANTS_API_KEY を設定しました。テストを実行し、必要であれば修正を行ってください。
   ```

## 修正手順

### J-Quants API v1 -> v2 移行手順

#### 1. 変更点の概要

- **認証方式**: トークン方式 (ID Token) から API キー方式 (`x-api-key` ヘッダー) に変更。
- **エンドポイント**:
  - 上場銘柄一覧: `/v1/listed/info` -> `/v2/equities/master`
  - 財務情報: `/v1/fins/statements` -> `/v2/fins/summary`
  - 株価情報: `/v1/prices/daily_quotes` -> `/v2/equities/bars/daily`
- **レスポンス構造**: 各エンドポイントでフィールド名が短縮形に変更されている（例: `NetSales` -> `Sales`）。

#### 2. `app/controller/jquants/jquants_structs.go` の修正

API レスポンスを受け取る構造体を v2 の仕様に合わせて変更する。

- **`jquantsStockInfo`**:

  - `Code` (変更なし)
  - `CompanyName` -> `CoName`
  - `CompanyNameEnglish` -> `CoNameEn`
  - `Sector17Code` -> `S17`
  - `Sector33Code` -> `S33`
  - `ScaleCategory` -> `ScaleCat`
  - `MarketCode` -> `Mkt`
  - その他、`S17Nm`, `S33Nm`, `MktNm` などが追加されているが、既存ロジックに必要なものだけマッピングすれば良い。

- **`jquantsStatementInfo`**:

  - `DisclosureNumber` -> `DiscNo`
  - `DisclosedDate` -> `DiscDate`
  - `TypeOfDocument` -> `DocType`
  - `NetSales` -> `Sales`
  - `OperatingProfit` -> `OP`
  - `OrdinaryProfit` -> `OdP`
  - `Profit` -> `NP`
  - `EarningsPerShare` -> `EPS`
  - `TotalAssets` -> `TA`
  - `Equity` -> `Eq`
  - `EquityToAssetRatio` -> `EqAR`
  - `BookValuePerShare` -> `BPS`
  - `CashFlowsFromOperatingActivities` -> `CFO`
  - `CashFlowsFromInvestingActivities` -> `CFI`
  - `CashFlowsFromFinancingActivities` -> `CFF`
  - `CashAndEquivalents` -> `CashEq`
  - 配当関連フィールドも大幅に変更（例: `ResultDividendPerShareAnnual` -> `DivAnn`）。
  - 予想関連フィールドも変更（例: `ForecastNetSales` -> `FSales`）。

- **`jquantsPriceInfo`**:
  - `Date` (変更なし)
  - `Code` (変更なし)
  - `AdjustmentOpen` -> `AdjO`
  - `AdjustmentHigh` -> `AdjH`
  - `AdjustmentLow` -> `AdjL`
  - `AdjustmentClose` -> `AdjC`
  - `AdjustmentVolume` -> `AdjVo`
  - `AdjustmentFactor` -> `AdjFactor`

#### 3. `app/controller/jquants/jquants.go` の修正

- **認証処理の削除**:

  - `fetchRefreshToken`, `fetchIdToken`, `setIdToken` 関数を削除。
  - `refreshToken`, `IdToken` 変数の削除。

- **共通関数 `get` の修正**:

  - `Authorization` ヘッダーの代わりに `x-api-key` ヘッダーを使用するように変更する。
  - 環境変数 `JQUANTS_API_KEY` を読み込む処理を追加（`init` 関数などで）。

- **`FetchStocksInfo`**:

  - URL: `https://api.jquants.com/v2/equities/master`
  - ヘッダー: `x-api-key`
  - マッピング処理: `jquantsStockInfo` の新フィールド名から `model.StocksInfo` へ変換。

- **`FetchStatementsInfo`**:

  - URL: `https://api.jquants.com/v2/fins/summary`
  - ヘッダー: `x-api-key`
  - マッピング処理: `jquantsStatementInfo` の新フィールド名から `model.StatementInfo` へ変換。

- **`FetchPricesInfo`**:
  - URL: `https://api.jquants.com/v2/equities/bars/daily`
  - ヘッダー: `x-api-key`
  - マッピング処理: `jquantsPriceInfo` の新フィールド名から `model.PriceInfo` へ変換。

#### 4. 環境変数の設定

- `.env` ファイル（または環境変数設定）で `JQUANTS_EMAIL`, `JQUANTS_PASS` を廃止し、`JQUANTS_API_KEY` を追加する。
